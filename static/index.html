<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Hydraulic Brakes Catalog Search</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Arial; margin: 18px; }
    .filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
    input[type="search"], select { padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    #q { width: 300px; }
    button { padding: 8px 16px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #005a9e; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .result { border-bottom: 1px solid #ddd; padding: 12px 0; display:flex; gap:15px; align-items:flex-start; cursor:pointer; }
    .result:hover { background: #f5f5f5; }
    .thumb { width:80px; height:80px; object-fit:cover; border:1px solid #ccc; border-radius: 4px; }
    .details { flex:1; }
    .part-badge { background: #007acc; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 8px; }
    .fort-pro-badge { background: #ff6b00; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 8px; }
    .viewer { margin-top:20px; border:1px solid #ccc; padding:20px; border-radius: 5px; background: #f9f9f9; }
    img.page { max-width:100%; height:auto; display:block; border: 1px solid #ddd; border-radius: 4px; }
    .loading { text-align: center; padding: 40px; color: #666; font-size: 18px; }
    .error { color: #d00; padding: 15px; background: #fee; border: 1px solid #fcc; border-radius: 4px; margin: 10px 0; }
    .results-info { margin: 10px 0; color: #666; font-style: italic; }
    .no-results { text-align: center; padding: 40px; color: #888; font-size: 16px; }
    .searching { display: inline-block; margin-left: 10px; }
    .fort-pro-toggle { display: flex; align-items: center; gap: 8px; margin-right: 10px; }
    .fort-pro-toggle input[type="checkbox"] { width: 18px; height: 18px; }
  </style>
</head>
<body>
  <h2>Hydraulic Brakes Catalog — Search</h2>
  
  <form id="searchForm">
    <div class="filters">
      <input id="q" type="search" placeholder="Enter part number (e.g., D50, 600-216, CH5500)..." />
      <select id="category">
        <option value="">All Categories</option>
      </select>
      <select id="part_type">
        <option value="">All Part Types</option>
      </select>
      <div class="fort-pro-toggle">
        <input type="checkbox" id="fort_pro" />
        <label for="fort_pro">Fort Pro Only</label>
      </div>
      <button type="submit" id="searchBtn">Search</button>
      <button type="button" id="showAll">Show All Parts</button>
    </div>
  </form>

  <div id="results"></div>

  <div id="viewer" class="viewer" style="display:none;">
    <h3 id="v-title"></h3>
    <div id="v-meta"></div>
    <div id="v-image"></div>
    <details style="margin-top:12px;">
      <summary>Page Text (truncated)</summary>
      <pre id="v-text" style="white-space:pre-wrap; max-height:240px; overflow:auto; background:#f9f9f9; padding:10px;"></pre>
    </details>
  </div>

<script>
// API base URL - change this if your server is on a different port
const API_BASE = 'http://localhost:8000';

// DOM elements
const form = document.getElementById('searchForm');
const qEl = document.getElementById('q');
const catEl = document.getElementById('category');
const typeEl = document.getElementById('part_type');
const fortProEl = document.getElementById('fort_pro');
const resultsEl = document.getElementById('results');
const searchBtn = document.getElementById('searchBtn');
const showAllBtn = document.getElementById('showAll');
const viewer = document.getElementById('viewer');
const vtitle = document.getElementById('v-title');
const vmeta = document.getElementById('v-meta');
const vimage = document.getElementById('v-image');
const vtext = document.getElementById('v-text');

// Global state
let currentSearchTerm = '';

// Load filters on page load
async function loadFilters() {
  try {
    showLoading(resultsEl, 'Loading filters...');
    
    const [catRes, typeRes] = await Promise.all([
      fetch(`${API_BASE}/categories`),
      fetch(`${API_BASE}/part_types`)
    ]);
    
    if (!catRes.ok) throw new Error(`Categories: ${catRes.status}`);
    if (!typeRes.ok) throw new Error(`Part types: ${typeRes.status}`);
    
    const cats = await catRes.json();
    const types = await typeRes.json();
    
    // Clear existing options except the first one
    while (catEl.children.length > 1) catEl.removeChild(catEl.lastChild);
    while (typeEl.children.length > 1) typeEl.removeChild(typeEl.lastChild);
    
    // Add categories
    if (cats.categories && cats.categories.length > 0) {
      cats.categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.text = cat;
        catEl.appendChild(option);
      });
    }
    
    // Add part types
    if (types.part_types && types.part_types.length > 0) {
      types.part_types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.text = type.charAt(0).toUpperCase() + type.slice(1);
        typeEl.appendChild(option);
      });
    }
    
    resultsEl.innerHTML = '<div class="results-info">Ready to search. Try entering a part number like "D50" or "600-216"</div>';
    
  } catch (error) {
    console.error('Failed to load filters:', error);
    showError(resultsEl, `Failed to load filters: ${error.message}`);
  }
}

// Form submission handler
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  await performSearch();
});

// Show all parts handler
showAllBtn.addEventListener('click', async () => {
  qEl.value = '';
  currentSearchTerm = '';
  await performSearch();
});

// Perform search
async function performSearch() {
  const q = qEl.value.trim() || null;
  const category = catEl.value || null;
  const partType = typeEl.value || null;
  const fortPro = fortProEl.checked;
  
  currentSearchTerm = q;
  
  // Show loading state
  setButtonLoading(true);
  showLoading(resultsEl, 'Searching...');
  
  try {
    const params = new URLSearchParams();
    if (q) params.append('q', q);
    if (category) params.append('category', category);
    if (partType) params.append('part_type', partType);
    if (fortPro) params.append('fort_pro', 'true');
    params.append('limit', '200');
    
    const res = await fetch(`${API_BASE}/search?${params}`);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const data = await res.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    renderResults(data);
    
  } catch (error) {
    console.error('Search error:', error);
    showError(resultsEl, `Search failed: ${error.message}`);
  } finally {
    setButtonLoading(false);
  }
}

// Render search results
function renderResults(data) {
  resultsEl.innerHTML = '';
  
  if (!data.count || !data.results || data.results.length === 0) {
    resultsEl.innerHTML = `
      <div class="no-results">
        <h3>No results found</h3>
        <p>Try searching for part numbers like:</p>
        <ul style="text-align: left; display: inline-block;">
          <li>D50, D52, D120 (Disc Brake Pads)</li>
          <li>600-216, 600-230 (Caliper)</li>
          <li>CH5500, CH5584 (Kit)</li>
        </ul>
        ${fortProEl.checked ? '<p><em>Or try unchecking "Fort Pro Only" to see more results</em></p>' : ''}
      </div>
    `;
    return;
  }
  
  const searchInfo = currentSearchTerm 
    ? `Found ${data.count} results for "${currentSearchTerm}"`
    : `Showing all ${data.count} parts`;
  
  const fortProInfo = fortProEl.checked ? ' (Fort Pro only)' : '';
  
  resultsEl.innerHTML = `<div class="results-info">${searchInfo}${fortProInfo}</div>`;
  
  data.results.forEach(result => {
    const div = document.createElement('div');
    div.className = 'result';
    
    const img = document.createElement('img');
    img.className = 'thumb';
    img.src = result.image_url || '';
    img.alt = `Page ${result.page}`;
    img.onerror = () => { img.style.display = 'none'; };
    
    const details = document.createElement('div');
    details.className = 'details';
    
    const badge = result.part_type 
      ? `<span class="part-badge">${result.part_type}</span>` 
      : '';
    
    const fortProBadge = result.fort_pro 
      ? `<span class="fort-pro-badge">Fort Pro</span>` 
      : '';
    
    details.innerHTML = `
      ${badge}${fortProBadge}<strong style="font-size: 1.1em;">${result.part_number}</strong>
      <div style="margin: 8px 0; color: #333;">${result.description || 'No description available'}</div>
      <small style="color: #666;">Page ${result.page} | Category: ${result.category || 'N/A'}</small>
    `;
    
    div.appendChild(img);
    div.appendChild(details);
    div.addEventListener('click', () => openPart(result.id));
    
    resultsEl.appendChild(div);
  });
}

// Open part details
async function openPart(id) {
  try {
    showLoading(viewer, 'Loading part details...');
    viewer.style.display = 'block';
    
    const res = await fetch(`${API_BASE}/part/${id}`);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    
    const part = await res.json();
    
    const fortProBadge = part.fort_pro 
      ? `<span class="fort-pro-badge">Fort Pro</span>` 
      : '';
    
    vtitle.innerHTML = `
      <span class="part-badge">${part.part_type || 'part'}</span> 
      ${fortProBadge}
      ${part.part_number}
    `;
    
    vmeta.innerHTML = `
      <div><strong>Description:</strong> ${part.description || 'N/A'}</div>
      <div><strong>Page:</strong> ${part.page} | <strong>Category:</strong> ${part.category || 'N/A'}</div>
      ${part.fort_pro ? '<div><strong>Fort Pro:</strong> Yes</div>' : ''}
    `;
    
    vtext.textContent = part.page_text || 'No page text available';
    
    if (part.image_url) {
      vimage.innerHTML = `
        <img class="page" src="${part.image_url}" alt="Page ${part.page}" 
             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
        <div style="color:#777; padding:20px; text-align:center; display:none;">
          Image failed to load
        </div>
      `;
    } else {
      vimage.innerHTML = `
        <div style="color:#777; padding:40px; text-align:center;">
          No page image available<br>
          <small>Run extraction with images enabled to see page images</small>
        </div>
      `;
    }
    
    viewer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
  } catch (error) {
    console.error('Error loading part:', error);
    vtitle.innerHTML = 'Error';
    vmeta.innerHTML = `<div class="error">Failed to load part details: ${error.message}</div>`;
    vimage.innerHTML = '';
    vtext.textContent = '';
  }
}

// Utility functions
function showLoading(element, message = 'Loading...') {
  element.innerHTML = `
    <div class="loading">
      <div>${message}</div>
      <div class="searching">⏳</div>
    </div>
  `;
}

function showError(element, message) {
  element.innerHTML = `<div class="error">${message}</div>`;
}

function setButtonLoading(loading) {
  searchBtn.disabled = loading;
  showAllBtn.disabled = loading;
  searchBtn.textContent = loading ? 'Searching...' : 'Search';
}

// Add some example search terms for quick testing
function addQuickExamples() {
  const examples = [
    { term: 'D50', desc: 'Disc Pad' },
    { term: '600-216', desc: 'Caliper' },
    { term: 'CH5500', desc: 'Kit' },
    { term: 'D120', desc: 'Ford Disc Pad' }
  ];
  
  const examplesDiv = document.createElement('div');
  examplesDiv.style.margin = '10px 0';
  examplesDiv.innerHTML = `
    <div style="font-size: 14px; color: #666;">
      Quick examples: 
      ${examples.map(ex => 
        `<a href="#" style="margin: 0 8px; color: #007acc; text-decoration: none;" 
            onclick="document.getElementById('q').value='${ex.term}'; performSearch(); return false;">
          ${ex.term} (${ex.desc})
        </a>`
      ).join('')}
    </div>
  `;
  
  form.parentNode.insertBefore(examplesDiv, form.nextSibling);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
  loadFilters();
  addQuickExamples();
  
  // Focus on search input
  qEl.focus();
  
  // Add input event for real-time search (optional)
  qEl.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      performSearch();
    }
  });
  
  // Add change event for Fort Pro checkbox to trigger search
  fortProEl.addEventListener('change', () => {
    performSearch();
  });
});
</script>
</body>
</html>